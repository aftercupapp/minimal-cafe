<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minimal Cafe</title>
    <style>
        :root {
            --bg: #ffffff;
            --ink: #000000;
            --border: 3px solid var(--ink);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg);
            color: var(--ink);
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 16px; 
        }

        header {
            border-bottom: var(--border);
            height: 55px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
            background: white;
            z-index: 10;
        }

        h1 { font-size: 1.1rem; font-weight: 900; letter-spacing: 1px; }

        .interactive { cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
        .interactive:active { border-bottom: 2px solid black; }
        
        #btn-help {
            font-weight: bold; border: 2px solid black; 
            width: 30px; height: 30px; text-align: center; 
            line-height: 26px; cursor: pointer; font-size: 1.1rem;
        }

        .overlay {
            display: none; position: absolute;
            top: 55px; left: 0; right: 0; bottom: 0;
            background: white; z-index: 99;
            padding: 20px; overflow-y: auto;
            border-top: var(--border);
        }
        
        .overlay.visible { display: block; }
        
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 15px; margin-bottom: 25px;
            border-bottom: var(--border); padding-bottom: 25px;
        }
        .stat-box {
            border: 2px solid black; padding: 15px; text-align: center;
        }
        .stat-val { font-size: 1.4rem; font-weight: 900; display: block; }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; font-weight: bold; }

        .history-list { list-style: none; margin-bottom: 20px; padding-left: 0; }
        
        .history-item {
            display: grid; 
            grid-template-columns: 50px 1fr auto;
            align-items: center;
            gap: 10px;
            border-bottom: 1px dashed black; 
            padding: 12px 0;
            font-size: 0.95rem;
        }
        
        .hist-face { font-size: 0.9rem; white-space: pre; text-align: center; overflow: hidden;}
        .hist-details { display: flex; flex-direction: column; }
        .hist-name { font-weight: 900; font-size: 0.9rem; }
        .hist-order { font-size: 0.85rem; opacity: 0.8; }
        .hist-win { color: black; }
        .hist-loss { text-decoration: line-through; opacity: 0.5; }

        .btn-full {
            width: 100%; height: 50px; 
            border: 2px solid black; background: white; 
            font-weight: 900; cursor: pointer; margin-top: 15px;
            font-family: inherit; text-transform: uppercase;
            font-size: 1.1rem;
        }
        .btn-full:active { background: black; color: white; }
        .btn-danger { border-color: black; color: black; opacity: 0.6; font-size: 0.9rem; }

        .help-section { margin-bottom: 25px; border-bottom: 2px solid black; padding-bottom: 25px; }
        .key-row { display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 10px; font-weight: 500; }
        .key-box { font-weight: 900; background: black; color: white; padding: 2px 8px; border-radius: 2px; }
        
        .info-block { font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; font-weight: 500; }
        .info-title { font-weight: 900; text-decoration: underline; display: block; margin-bottom: 5px; font-size: 1rem;}

        .recipe-row {
            display: flex; justify-content: space-between;
            border-bottom: 1px dashed black; padding: 12px 0;
            font-size: 0.95rem; font-weight: 500;
        }

        #game-layout {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        section {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
        }

        #customer-view {
            background: white;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        #face {
            font-size: 3rem; margin-bottom: 15px; font-weight: 900;
            height: 70px; display: flex; align-items: center; justify-content: center; width: 100%;
        }
        
        #customer-name-tag {
            font-weight: 900; border: 2px solid black; padding: 6px 12px;
            margin-bottom: 25px; font-size: 1.1rem; background: black;
            color: white; border-radius: 4px;
        }

        #speech-bubble {
            border: 2px solid var(--ink);
            padding: 25px; position: relative;
            background: white; width: 100%; max-width: 400px;
            box-shadow: 10px 10px 0 var(--ink);
        }
        
        #speech-bubble::after {
            content: ''; position: absolute; top: -15px; left: 50%;
            border-width: 0 15px 15px; border-style: solid;
            border-color: var(--ink) transparent;
            transform: translateX(-50%);
        }

        #order-name { font-size: 1.6rem; font-weight: 900; display: block; margin-top: 10px; line-height: 1.2; }

        #prep-view { 
            background: white;
            display: flex;
            flex-direction: column;
        }

        #kitchen-display {
            flex-grow: 1;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            border-bottom: var(--border);
        }

        #cup-container {
            width: 130px;
            height: 160px;
            border: 5px solid var(--ink);
            border-top: none;
            border-radius: 0 0 15px 15px;
            display: flex;
            flex-direction: column-reverse;
            padding: 4px;
            position: relative;
            background: white;
            margin-right: 35px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }

        #cup-container::after {
            content: '';
            position: absolute;
            top: 25%;
            right: -34px;
            width: 30px;
            height: 50%;
            border: 5px solid var(--ink);
            border-left: none;
            border-radius: 0 20px 20px 0;
        }

        .ingredient-layer {
            width: 100%; height: 20%; 
            border: 1px solid var(--ink);
            text-align: center; font-size: 0.7rem; 
            line-height: 28px; font-weight: 900;
            overflow: hidden; white-space: nowrap;
            background: white;
            border-radius: 2px;
            margin-top: 1px;
        }
        
        .ingredient-layer:first-child {
             border-radius: 0 0 10px 10px;
             margin-top: 0;
        }

        #keyboard-legend {
            width: 100%;
            flex-shrink: 0;
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
            font-size: 0.9rem;
            background: white;
            border-top: 1px solid #eee;
            overflow-x: hidden;
        }

        .legend-cat {
            font-weight: 900;
            border-bottom: 2px solid black;
            margin-top: 10px;
            margin-bottom: 5px;
            grid-column: span 2;
            font-size: 1rem;
        }
        
        .legend-key { font-weight: 900; background: black; color: white; padding: 2px 8px; display: inline-block; min-width: 24px; text-align: center; border-radius: 2px;}
        .legend-item { display: flex; justify-content: space-between; align-items: center; white-space: nowrap; font-weight: 500; }

        @media (max-width: 600px) {
            #keyboard-legend {
                grid-template-columns: 1fr 1fr; 
                font-size: 0.9rem; 
                padding: 15px;
                max-height: 48vh;
                overflow-y: auto;
            }
            .legend-cat {
                grid-column: span 2;
                border-bottom: 2px solid black;
                margin-top: 15px;
            }
            #kitchen-display {
                border-bottom: var(--border);
            }
            #cup-container {
                transform: scale(0.95);
                margin: 0 auto 0 auto;
                left: -10px;
            }
            .shop-name { font-size: 0.9rem; }
            .shop-price { font-size: 0.85rem; font-weight: bold; }
            .buy-btn { font-size: 1rem; padding: 10px; }
        }

        #storage-view {
            background: white;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .brew-station {
            border: 3px solid black;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
            background: #f0f0f0;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .shop-item {
            border: 2px solid black;
            padding: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .shop-name { font-weight: 900; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 5px; }
        .shop-stock { font-size: 1.4rem; font-weight: 900; margin: 8px 0; }
        .shop-price { font-size: 0.85rem; font-weight: bold; }
        
        .buy-btn {
            background: black; color: white; border: none;
            padding: 8px; font-weight: 900; cursor: pointer;
            margin-top: 8px; font-family: inherit; font-size: 0.9rem;
            text-transform: uppercase;
        }
        .buy-btn:active { opacity: 0.7; }
        .buy-btn:disabled { background: #ccc; cursor: not-allowed; }

        .nav-hint {
            text-align: center;
            padding: 15px;
            font-size: 1rem;
            font-weight: bold;
            opacity: 0.5;
            margin-top: 25px;
            border-top: 1px solid #ddd;
        }

        nav {
            height: 65px; 
            border-top: var(--border);
            display: flex; flex-shrink: 0;
        }
        .nav-tab {
            flex: 1; border: none; background: white;
            font-family: inherit; font-size: 1.2rem; font-weight: 900;
            border-right: var(--border); cursor: pointer; text-transform: uppercase;
        }
        .nav-tab.active { background: black; color: white; }
        .nav-tab:last-child { border-right: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div id="cash-display" class="interactive" onclick="toggleOverlay('profile')">
            $0.00 &#9662; 
        </div>
        <h1>MINIMAL CAFE</h1>
        <div id="btn-help" onclick="toggleOverlay('help')">?</div>
    </header>

    <div id="profile-overlay" class="overlay">
        <h2 style="text-align:center; text-decoration: underline; font-weight:900;">BARISTA PROFILE</h2>
        <br>
        <div class="stat-grid">
            <div class="stat-box">
                <span id="stat-rank" class="stat-val">INTERN</span>
                <span class="stat-label">Rank</span>
            </div>
            <div class="stat-box">
                <span id="stat-accuracy" class="stat-val">100%</span>
                <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-box" style="grid-column: span 2">
                <span id="stat-served" class="stat-val">0</span>
                <span class="stat-label">Total Served</span>
            </div>
        </div>

        <h3>HISTORY (Last 10)</h3>
        <ul id="history-list" class="history-list">
            <li class="history-item" style="justify-content:center; color:#888;">No orders yet.</li>
        </ul>
        
        <button class="btn-full" onclick="navBack()">CLOSE PROFILE</button>
        <button class="btn-full btn-danger" onclick="resetSaveData()">RESET DATA</button>
        <div style="text-align: center; margin-top: 20px; font-size: 0.9rem; font-weight:bold; opacity: 0.4;">v0.1.14</div>
    </div>

    <div id="help-overlay" class="overlay">
        
        <div class="help-section">
            <h2 style="text-align: center; text-decoration: underline; font-weight:900;">RECIPES</h2>
            <div id="recipe-list"></div>
        </div>

        <div class="help-section">
            <h2 style="text-align: center; text-decoration: underline; font-weight:900;">CONTROLS</h2>
            <br>
            <div class="key-row"><span>Light Roast</span><span class="key-box">1</span></div>
            <div class="key-row"><span>Medium Roast</span><span class="key-box">2</span></div>
            <div class="key-row"><span>Dark Roast</span><span class="key-box">3</span></div>
            <div class="key-row"><span>Steamed Milk</span><span class="key-box">M</span></div>
            <div class="key-row"><span>Hot Water</span><span class="key-box">W</span></div>
            <div class="key-row"><span>Milk Foam</span><span class="key-box">F</span></div>
            <div class="key-row"><span>Batch Brew</span><span class="key-box">B</span></div>
            <div class="key-row"><span>Cold Brew</span><span class="key-box">K</span></div>
            <div class="key-row"><span>Tonic Water</span><span class="key-box">N</span></div>
            <div class="key-row"><span>Ice</span><span class="key-box">I</span></div>
            <div class="key-row"><span>Chocolate</span><span class="key-box">C</span></div>
            <div class="key-row"><span>Caramel</span><span class="key-box">A</span></div>
            <div class="key-row"><span>Matcha</span><span class="key-box">T</span></div>
            <div class="key-row"><span>Chai</span><span class="key-box">H</span></div>
            <br>
            <div class="key-row"><span>Serve</span><span class="key-box">ENTER</span></div>
            <div class="key-row"><span>Trash Cup</span><span class="key-box">BKSP</span></div>
            <div class="key-row"><span>Cycle View</span><span class="key-box">SPACE</span></div>
        </div>

        <div class="help-section" style="border-bottom:none;">
            <h2 style="text-align: center; text-decoration: underline; font-weight:900;">COFFEE KNOWLEDGE</h2>
            <br>
            <div class="info-block">
                <span class="info-title">COLD BREW</span>
                Coarse coffee grounds steeped in room-temperature or cold water for 12-24 hours. The result is smooth, full-bodied, and has lower acidity than hot coffee.
            </div>
            <div class="info-block">
                <span class="info-title">GOOD ESPRESSO</span>
                Extracted under high pressure (9 bars). A perfect shot balances acidity, sweetness, and bitterness, topped with a golden-brown foam layer called 'crema'.
            </div>
        </div>

        <br>
        <button class="btn-full" onclick="navBack()">CLOSE HELP</button>
        <div style="height:50px;"></div>
    </div>

    <div id="game-layout">
        
        <section id="customer-view">
            <div id="face"></div>
            <div id="customer-name-tag"></div>
            
            <div id="speech-bubble">
                <div style="font-style:italic; font-size: 1rem;" id="mood-text"></div>
                <span id="order-name"></span>
            </div>
            <br>
            <div style="font-size: 0.9rem; font-weight:bold; opacity: 0.5;">[SPACE] TO KITCHEN</div>
        </section>

        <section id="prep-view" class="hidden">
            <div id="kitchen-display">
                <div id="cup-container"></div>
            </div>
            
            <div id="keyboard-legend">
                <div class="legend-cat">ROASTS</div>
                <div class="legend-item">Light Roast <span class="legend-key">1</span></div>
                <div class="legend-item">Medium Roast <span class="legend-key">2</span></div>
                <div class="legend-item">Dark Roast <span class="legend-key">3</span></div>
                
                <div class="legend-cat">BASES</div>
                <div class="legend-item">Milk <span class="legend-key">M</span></div>
                <div class="legend-item">Water <span class="legend-key">W</span></div>
                <div class="legend-item">Foam <span class="legend-key">F</span></div>
                <div class="legend-item">Batch Brew <span class="legend-key">B</span></div>
                <div class="legend-item">Cold Brew <span class="legend-key">K</span></div>
                
                <div class="legend-cat">ADD-ONS</div>
                <div class="legend-item">Ice <span class="legend-key">I</span></div>
                <div class="legend-item">Tonic <span class="legend-key">N</span></div>
                <div class="legend-item">Choco <span class="legend-key">C</span></div>
                <div class="legend-item">Caramel <span class="legend-key">A</span></div>
                
                <div class="legend-cat">TEA</div>
                <div class="legend-item">Matcha <span class="legend-key">T</span></div>
                <div class="legend-item">Chai <span class="legend-key">H</span></div>
                
                <div class="legend-cat">ACTIONS</div>
                <div class="legend-item">Serve <span class="legend-key">ENT</span></div>
                <div class="legend-item">Trash <span class="legend-key">DEL</span></div>
                <div class="legend-item">View <span class="legend-key">SPC</span></div>
            </div>
        </section>

        <!-- STORAGE VIEW -->
        <section id="storage-view" class="hidden">
            <h2 style="text-align: center; margin-bottom: 20px; text-decoration: underline; font-weight:900;">INVENTORY</h2>
            
            <div class="brew-station">
                <h3 style="font-weight:900;">COLD BREW STATION</h3>
                <p id="brew-status" style="font-size: 1rem; font-weight:bold; margin: 10px 0;">Status: Idle</p>
                <button id="brew-btn" class="btn-full" onclick="handleColdBrew()">START BATCH ($50)</button>
                <div style="font-size: 0.85rem; font-weight:bold; margin-top: 10px; opacity:0.7;">Takes 2 Hours. Yields 10 portions.</div>
            </div>

            <div class="shop-grid" id="shop-container">
                <!-- Items populated by JS -->
            </div>
            
            <div class="nav-hint">[SPACE] TO CUSTOMER</div>
            <div style="height: 50px;"></div>
        </section>

    </div>

    <nav>
        <button id="tab-counter" class="nav-tab active" onclick="goToCounter()">Customer</button>
        <button id="tab-kitchen" class="nav-tab" onclick="goKitchen()">Kitchen</button>
        <button id="tab-storage" class="nav-tab" onclick="goStorage()">Storage</button>
    </nav>

    <script>
        const RECIPES = {
            'Espresso':         ['Espresso'],
            'Americano':        ['Water', 'Espresso'],
            'Latte':            ['Milk', 'Espresso', 'Foam'],
            'Cappuccino':       ['Milk', 'Foam', 'Espresso'],
            'Flat White':       ['Milk', 'Espresso', 'Espresso'],
            'Mocha':            ['Chocolate', 'Milk', 'Espresso'],
            'Iced Coffee':      ['Ice', 'Espresso', 'Milk'],
            'Caramel Macchiato':['Caramel', 'Milk', 'Espresso'],
            'Matcha Latte':     ['Matcha', 'Milk', 'Foam'],
            'Dirty Chai':       ['Chai', 'Espresso', 'Milk'],
            'Chai Latte':       ['Chai', 'Milk', 'Foam'],
            'Cold Brew':        ['Ice', 'Cold Brew'],
            'Batch Brew':       ['Batch Brew'],
            'Espresso Tonic':   ['Tonic', 'Ice', 'Espresso']
        };

        const FACES_NEUTRAL = [
            "(˶ᵔ ᵕ ᵔ˶)", "( ˙꒳​˙ )", "(ㆆ_ㆆ)", "ᗜ⩊ᗜ", "≽^•⩊•^≼", "( ͡° ͜ʖ ͡°)",
            "(・_・;)", "(¬_¬)", "(o_O)", "(•_•)", "ʕ •ᴥ•ʔ", "(=^･ω･^=)",
            "( ◡‿◡ )", "(◕‿◕)", "(・∀・)", "(｡•̀ᴗ-)✧", "( ˘▽˘)っ"
        ];
        
        const FACES_HAPPY = [
            "⸜(｡˃ ᵕ ˂ )⸝♡", "(੭˃ᴗ˂)੭", "( ˘ ³˘)♥", "(≧◡≦)", "(´｡• ᵕ •｡`)",
            "(⌒▽⌒)☆", "(o^▽^o)", "(* ^ ω ^)", "(´• ω •`)", "╰(*´︶`*)╯",
            "(☆▽☆)", "(✯◡✯)", "\\(★ω★)/", "( ˙꒳​˙ )b", "(๑˃ᴗ˂)ﻭ"
        ];
        
        const FACES_SAD = [
            "(╥﹏╥)", "(ง •̀_•́)ง", "¯\\_(ツ)_/¯", "(mu_m)", "(T_T)",
            "(>-<)", "(;;;*_*)", "(´･_･`)", "(ノ_<。)", "(｡•́︿•̀｡)",
            "(＃`Д´)", "(；￣Д￣)", "(￣ ￣|||)"
        ];

        const NAMES = [
            "Luna", "Bella", "Daisy", "Ruby", "Lily", "Zoe", "Chloe", "Sophie", 
            "Mia", "Emma", "Ava", "Ivy", "Nora", "Grace", "Hazel", "Violet",
            "Aurora", "Penny", "Stella", "Lucy", "Maya", "Kiki", "Momo", "Coco",
            "Lulu", "Mimi", "Bibi", "Yumi", "Hana", "Nina", "Rina", "Tina",
            "Fifi", "Gigi", "Jojo", "Pippa", "Poppy", "Rosie", "Sasha"
        ];

        const SAVE_KEY = 'minimalCafeSave_v23';
        
        const SHOP_ITEMS = {
            'light_beans': { name: 'Light Roast Beans', price: 15, qty: 10 },
            'med_beans':   { name: 'Medium Roast Beans',   price: 15, qty: 10 },
            'dark_beans':  { name: 'Dark Roast Beans',  price: 15, qty: 10 },
            'milk':        { name: 'Steamed Milk', price: 10, qty: 10 },
            'tonic':       { name: 'Tonic Water', price: 20, qty: 5 },
            'ice':         { name: 'Ice Cubes',  price: 5,  qty: 20 },
            'choco':       { name: 'Chocolate Syrup', price: 25, qty: 10 },
            'caramel':     { name: 'Caramel Syrup', price: 25, qty: 10 },
            'matcha':      { name: 'Matcha Powder',  price: 30, qty: 10 },
            'chai':        { name: 'Chai Concentrate',  price: 25, qty: 10 }
        };

        const defaultState = {
            cash: 50, 
            totalServed: 0,
            totalCorrect: 0,
            history: [],
            inventory: {
                'light_beans': 10, 'med_beans': 10, 'dark_beans': 10,
                'milk': 10, 'ice': 10, 'tonic': 10, 'choco': 10,
                'caramel': 10, 'matcha': 10, 'chai': 10,
                'cold_brew': 10
            },
            brewFinishTime: 0, 
            isBrewing: false
        };

        let state = { 
            ...defaultState,
            cup: [], 
            target: null, 
            running: false,
            currentCustomerName: "",
            currentView: 'counter'
        };

        function loadGame() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    state.inventory = { ...defaultState.inventory, ...(parsed.inventory || {}) };
                } catch (e) {
                    console.error("Save file corrupted, using defaults");
                }
            }
            updateCashDisplay();
            updateShopUI();
            updateBrewUI();
        }

        function saveGame() {
            const dataToSave = {
                cash: state.cash,
                totalServed: state.totalServed,
                totalCorrect: state.totalCorrect,
                history: state.history,
                inventory: state.inventory,
                brewFinishTime: state.brewFinishTime,
                isBrewing: state.isBrewing
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(dataToSave));
        }

        function resetSaveData() {
            if(confirm("Are you sure? This will delete all progress.")) {
                localStorage.removeItem(SAVE_KEY);
                location.reload();
            }
        }

        const ui = {
            counter: document.getElementById('customer-view'),
            kitchen: document.getElementById('prep-view'),
            storage: document.getElementById('storage-view'),
            tabCounter: document.getElementById('tab-counter'),
            tabKitchen: document.getElementById('tab-kitchen'),
            tabStorage: document.getElementById('tab-storage'),
            cup: document.getElementById('cup-container'),
            face: document.getElementById('face'),
            nameTag: document.getElementById('customer-name-tag'),
            orderName: document.getElementById('order-name'),
            mood: document.getElementById('mood-text'),
            cash: document.getElementById('cash-display'),
            profileOverlay: document.getElementById('profile-overlay'),
            helpOverlay: document.getElementById('help-overlay'),
            recipeList: document.getElementById('recipe-list'),
            historyList: document.getElementById('history-list'),
            shopContainer: document.getElementById('shop-container'),
            brewStatus: document.getElementById('brew-status'),
            brewBtn: document.getElementById('brew-btn'),
            stats: {
                rank: document.getElementById('stat-rank'),
                acc: document.getElementById('stat-accuracy'),
                served: document.getElementById('stat-served')
            }
        };

        function init() {
            loadGame();
            history.replaceState({view: 'counter'}, '');

            let html = '';
            for(let [name, ingredients] of Object.entries(RECIPES)) {
                let dispIng = ingredients.map(i => i === 'Espresso' ? 'Espresso (Any)' : i).join(' + ');
                html += `
                <div class="recipe-row">
                    <span><b>${name}</b></span>
                    <span>${dispIng}</span>
                </div>`;
            }
            ui.recipeList.innerHTML = html;
            
            setInterval(updateBrewUI, 30000); 
            updateBrewUI();
            
            nextCustomer();
        }

        function updateView(mode) {
            state.currentView = mode;
            
            ui.counter.classList.add('hidden');
            ui.kitchen.classList.add('hidden');
            ui.storage.classList.add('hidden');
            ui.tabCounter.classList.remove('active');
            ui.tabKitchen.classList.remove('active');
            ui.tabStorage.classList.remove('active');

            if (mode === 'counter') {
                ui.counter.classList.remove('hidden');
                ui.tabCounter.classList.add('active');
            } else if (mode === 'kitchen') {
                ui.kitchen.classList.remove('hidden');
                ui.tabKitchen.classList.add('active');
            } else if (mode === 'storage') {
                ui.storage.classList.remove('hidden');
                ui.tabStorage.classList.add('active');
                updateShopUI();
                updateBrewUI();
            }
        }

        function goKitchen() {
            if(state.currentView === 'kitchen') return;
            history.pushState({view: 'kitchen'}, '');
            updateView('kitchen');
        }

        function goStorage() {
            if(state.currentView === 'storage') return;
            history.pushState({view: 'storage'}, '');
            updateView('storage');
        }

        function goToCounter() {
            history.pushState({view: 'counter'}, '');
            updateView('counter');
        }

        function navBack() {
            history.back();
        }

        function toggleMode() {
            if (state.currentView === 'counter') {
                goKitchen();
            } else if (state.currentView === 'kitchen') {
                goStorage();
            } else {
                goToCounter();
            }
        }

        function toggleOverlay(type) {
            const isProfileOpen = ui.profileOverlay.classList.contains('visible');
            const isHelpOpen = ui.helpOverlay.classList.contains('visible');

            if ((type === 'profile' && isProfileOpen) || (type === 'help' && isHelpOpen)) {
                history.back();
                return;
            }

            const overlay = type === 'profile' ? ui.profileOverlay : ui.helpOverlay;
            history.pushState({view: 'overlay', type: type}, '');
            ui.profileOverlay.classList.remove('visible');
            ui.helpOverlay.classList.remove('visible');
            overlay.classList.add('visible');
            if(type === 'profile') updateProfileUI();
        }

        window.addEventListener('popstate', (e) => {
            ui.profileOverlay.classList.remove('visible');
            ui.helpOverlay.classList.remove('visible');
            
            if (e.state) {
                if(e.state.view === 'kitchen') updateView('kitchen');
                else if(e.state.view === 'storage') updateView('storage');
                else if(e.state.view === 'overlay') {
                    if(e.state.type === 'profile') {
                        ui.profileOverlay.classList.add('visible');
                        updateProfileUI();
                    } else {
                        ui.helpOverlay.classList.add('visible');
                    }
                } else {
                    updateView('counter');
                }
            } else {
                updateView('counter');
            }
        });

        function buyItem(key) {
            const item = SHOP_ITEMS[key];
            if(state.cash >= item.price) {
                state.cash -= item.price;
                state.inventory[key] += item.qty;
                updateCashDisplay();
                updateShopUI();
                saveGame();
            } else {
                alert("Not enough cash!");
            }
        }

        function updateShopUI() {
            ui.shopContainer.innerHTML = '';
            
            const cbDiv = document.createElement('div');
            cbDiv.className = 'shop-item';
            cbDiv.innerHTML = `
                <span class="shop-name">COLD BREW</span>
                <span class="shop-stock">${state.inventory['cold_brew']}</span>
                <span class="shop-price">Via Brew Station</span>
            `;
            ui.shopContainer.appendChild(cbDiv);

            for (const [key, item] of Object.entries(SHOP_ITEMS)) {
                const div = document.createElement('div');
                div.className = 'shop-item';
                const canAfford = state.cash >= item.price;
                
                div.innerHTML = `
                    <span class="shop-name">${item.name}</span>
                    <span class="shop-stock">${state.inventory[key] || 0}</span>
                    <span class="shop-price">$${item.price} / ${item.qty}</span>
                    <button class="buy-btn" onclick="buyItem('${key}')" ${canAfford ? '' : 'disabled'}>BUY</button>
                `;
                ui.shopContainer.appendChild(div);
            }
        }

        function handleColdBrew() {
            const now = Date.now();
            
            if (state.isBrewing) {
                if (now >= state.brewFinishTime) {
                    state.inventory['cold_brew'] += 10;
                    state.isBrewing = false;
                    state.brewFinishTime = 0;
                    alert("Cold Brew Collected!");
                } else {
                    alert("Still brewing... patience!");
                }
            } else {
                if (state.cash >= 50) {
                    state.cash -= 50;
                    state.isBrewing = true;
                    state.brewFinishTime = now + (2 * 60 * 60 * 1000); 
                    updateCashDisplay();
                } else {
                    alert("Need $50 to start batch!");
                }
            }
            updateBrewUI();
            saveGame();
        }

        function updateBrewUI() {
            if (!state.isBrewing) {
                ui.brewStatus.innerText = "Status: Idle";
                ui.brewBtn.innerText = "START BATCH ($50)";
                ui.brewBtn.disabled = false;
            } else {
                const now = Date.now();
                if (now >= state.brewFinishTime) {
                    ui.brewStatus.innerText = "Status: READY!";
                    ui.brewBtn.innerText = "COLLECT";
                    ui.brewBtn.disabled = false;
                } else {
                    const minutesLeft = Math.ceil((state.brewFinishTime - now) / 60000);
                    ui.brewStatus.innerText = `Status: Brewing (${minutesLeft}m left)`;
                    ui.brewBtn.innerText = "BREWING...";
                    ui.brewBtn.disabled = true;
                }
            }
        }

        function updateCashDisplay() {
            ui.cash.innerHTML = `$${state.cash.toFixed(2)} &#9662;`;
        }

        function updateProfileUI() {
            let rank = "INTERN";
            const m = state.cash;
            if (m > 50) rank = "JUNIOR BARISTA";
            if (m > 150) rank = "BARISTA";
            if (m > 300) rank = "SHIFT LEAD";
            if (m > 500) rank = "MANAGER";
            if (m > 800) rank = "ARTISAN";
            if (m > 1200) rank = "ROAST MASTER";
            if (m > 2000) rank = "CAFFEINE MOGUL";
            if (m > 3500) rank = "ESPRESSO TYCOON";
            if (m > 5000) rank = "COFFEE GOD";

            let acc = 0;
            if (state.totalServed > 0) {
                acc = Math.round((state.totalCorrect / state.totalServed) * 100);
            }

            ui.stats.rank.innerText = rank;
            ui.stats.acc.innerText = acc + "%";
            ui.stats.served.innerText = state.totalServed;

            ui.historyList.innerHTML = '';
            if (state.history.length === 0) {
                ui.historyList.innerHTML = '<li class="history-item" style="justify-content:center;">No orders yet.</li>';
                return;
            }

            [...state.history].reverse().forEach(h => {
                const li = document.createElement('li');
                li.className = `history-item ${h.win ? 'hist-win' : 'hist-loss'}`;
                const sign = h.win ? '+' : '';
                
                li.innerHTML = `
                    <div class="hist-face">${h.face || '(-)'}</div>
                    <div class="hist-details">
                        <span class="hist-name">${h.cName || 'Cust'}</span>
                        <span class="hist-order">${h.name}</span>
                    </div>
                    <span>${sign}$${h.amt.toFixed(2)}</span>
                `;
                ui.historyList.appendChild(li);
            });
        }

        function nextCustomer() {
            state.cup = [];
            renderCup();
            state.running = true;

            const names = Object.keys(RECIPES);
            const pick = names[Math.floor(Math.random() * names.length)];
            const baseSteps = RECIPES[pick];

            const roasts = ['LT.Esp', 'MD.Esp', 'DK.Esp'];
            const roastNames = {'LT.Esp': 'Light Roast', 'MD.Esp': 'Medium Roast', 'DK.Esp': 'Dark Roast'};
            
            const needsRoast = baseSteps.includes('Espresso');
            let displayOrderName = pick;
            let finalSteps = [];

            if (needsRoast) {
                const chosenRoast = roasts[Math.floor(Math.random() * roasts.length)];
                finalSteps = baseSteps.map(s => s === 'Espresso' ? chosenRoast : s);
                displayOrderName = `${roastNames[chosenRoast]} ${pick}`;
            } else {
                finalSteps = [...baseSteps];
            }

            state.target = { name: displayOrderName, steps: finalSteps };

            ui.face.innerText = FACES_NEUTRAL[Math.floor(Math.random() * FACES_NEUTRAL.length)];
            
            const custName = NAMES[Math.floor(Math.random() * NAMES.length)];
            state.currentCustomerName = custName;
            ui.nameTag.innerText = custName;
            
            ui.mood.innerText = "Hello! Can I have a...";
            ui.orderName.innerText = displayOrderName;
            
            updateView('counter');
        }

        function getInventoryKey(ing) {
            if(ing === 'DK.Esp') return 'dark_beans';
            if(ing === 'MD.Esp') return 'med_beans';
            if(ing === 'LT.Esp') return 'light_beans';
            if(ing === 'Batch Brew') return 'med_beans'; 
            if(ing === 'Cold Brew') return 'cold_brew';
            if(ing === 'Milk' || ing === 'Foam') return 'milk';
            if(ing === 'Ice') return 'ice';
            if(ing === 'Tonic') return 'tonic';
            if(ing === 'Chocolate') return 'choco';
            if(ing === 'Caramel') return 'caramel';
            if(ing === 'Matcha') return 'matcha';
            if(ing === 'Chai') return 'chai';
            return null; 
        }

        function add(ingredient) {
            if(ui.profileOverlay.classList.contains('visible') || 
               ui.helpOverlay.classList.contains('visible')) return;
               
            if (!state.running) return;
            if (state.cup.length >= 5) return;

            const stockKey = getInventoryKey(ingredient);
            if (stockKey) {
                if (state.inventory[stockKey] > 0) {
                    state.inventory[stockKey]--;
                } else {
                    alert("OUT OF STOCK! Buy more in Storage.");
                    return;
                }
            }

            state.cup.push(ingredient);
            renderCup();
            saveGame(); 
        }

        function clearCup() {
            state.cup = [];
            renderCup();
        }

        function renderCup() {
            ui.cup.innerHTML = '';
            state.cup.forEach(ing => {
                const div = document.createElement('div');
                div.className = 'ingredient-layer';
                if (ing.includes('DK')) div.style.background = '#333';
                if (ing.includes('DK')) div.style.color = 'white';
                if (ing.includes('MD')) div.style.background = '#777';
                if (ing.includes('MD')) div.style.color = 'white';
                if (ing.includes('LT')) div.style.background = '#ddd';
                
                div.innerText = ing.toUpperCase();
                ui.cup.appendChild(div);
            });
        }

        function serve() {
            if (!state.running) return;

            const required = state.target.steps;
            let correct = true;
            
            if (state.cup.length !== required.length) correct = false;
            else {
                for(let i=0; i<required.length; i++) {
                    if (state.cup[i] !== required[i]) correct = false;
                }
            }

            state.totalServed++;
            let amt = 0;
            let resultFace = "";

            if (correct) {
                state.totalCorrect++;
                amt = 5.50;
                state.cash += amt;
                ui.mood.innerText = "PERFECT!";
                ui.orderName.innerText = "Thanks! (+$5.50)";
                resultFace = FACES_HAPPY[Math.floor(Math.random() * FACES_HAPPY.length)];
            } else {
                amt = 2.00;
                state.cash -= amt;
                ui.mood.innerText = "GROSS.";
                ui.orderName.innerText = "I'm leaving. (-$2.00)";
                resultFace = FACES_SAD[Math.floor(Math.random() * FACES_SAD.length)];
            }

            ui.face.innerText = resultFace;

            state.history.push({ 
                name: state.target.name, 
                win: correct, 
                amt: amt,
                cName: state.currentCustomerName,
                face: resultFace
            });

            if(state.history.length > 15) state.history.shift();
            
            saveGame();
            updateCashDisplay();
            
            state.running = false;
            goToCounter();

            setTimeout(() => { if(!state.running) nextCustomer(); }, 2000);
        }

        document.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            
            if(k === 'escape') {
                navBack();
                return;
            }

            if(ui.profileOverlay.classList.contains('visible') || 
               ui.helpOverlay.classList.contains('visible')) return;

            if(k === ' ') {
                e.preventDefault();
                toggleMode();
            }
            if(k === 'enter') serve();
            if(k === 'backspace' || k === 'delete') clearCup();

            if(['d','m','l','w','f','i','c','a','t','b','k','n'].includes(k)) goKitchen();

            if(k === '1') add('LT.Esp'); 
            if(k === '2') add('MD.Esp'); 
            if(k === '3') add('DK.Esp'); 
            
            if(k === 'm') add('Milk');
            if(k === 'w') add('Water');
            if(k === 'f') add('Foam');
            if(k === 'b') add('Batch Brew');
            if(k === 'k') add('Cold Brew');
            if(k === 'n') add('Tonic');
            
            if(k === 'i') add('Ice');
            if(k === 'c') add('Chocolate');
            if(k === 'a') add('Caramel');
            if(k === 't') add('Matcha');
            if(k === 'h') add('Chai');
        });

        init();
    </script>
</body>
</html>
